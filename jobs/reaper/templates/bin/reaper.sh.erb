<%
  elasticsearch_hosts = nil
  elasticsearch_port = nil
  if_link("elasticsearch") { |elasticsearch_link|
    elasticsearch_hosts = elasticsearch_link.instances.map { |instance| instance.address }
    elasticsearch_port = elasticsearch_link.p("elasticsearch.port")
  }
  unless elasticsearch_hosts
    elasticsearch_hosts = p("reaper.elasticsearch.host")
  end
%>

#!/bin/bash

set -e
set -u

ELASTICSEARCH_HOST='<%= elasticsearch_hosts %>'
THRESHOLD=<%= p('reaper.purge_logs.disk_threshold') %>
SKIP="<%= p('reaper.purge_logs.skip_index') %>"

export LC_ALL=en_US.UTF-8
export LANG=en_US.UTF-8

export PATH=/var/vcap/jobs/reaper/bin:$PATH
export PATH=/var/vcap/packages/curator/bin:$PATH
export PYTHONPATH=/var/vcap/packages/curator/lib/python3.6/site-packages/

python3 $(dirname "$0")/reaper.py \
 "$THRESHOLD" \
 "$ELASTICSEARCH_HOST" \
 "$SKIP"
